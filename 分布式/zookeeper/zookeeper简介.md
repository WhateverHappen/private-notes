# zookeeper是什么

zookeeper是一个典型的分布式数据一致性的解决方案，分布式应用程序可以基于它实现诸如数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master选举、分布式锁和分布式队列等功能。zookeeper可以保证如下分布式一致性特性。

### 顺序一致性

> 从同一个客户端发起的事务请求，最终将会严格地按照其发起顺序被应用到zookeeper中。

### 原子性

> 所有事务请求的处理结果在整个集群中所有机器上的应用情况是一致的，也就是说，要么整个集群所有机器都成功应用了某个事务，要么都没有应用，一定不会出现集群中部分机器应用了该事务，而另外一部分没有应用的情况

### 单一视图

> 无论客户端连接的是哪个zookeeper服务器，其看到的服务端数据模型都是一致的

### 可靠性

> 一旦服务端成功的应用了一个事务，并完成对客户端的响应，那么该事务所引起的服务端状态变更将会被一直保留下来，除非有另一个事务又对其进行了变更。

### 实时性

> 通常人们看到实时性的第一反应是，一旦一个事务被成功应用，那么客户端能够立即从服务端上读取到这个事务变更后的最新数据状态。这里需要注意的是，**zookeeper仅仅保证在一定的时间段内，客户端最终一定能够从服务端上读取到最新的数据状态**。

# zookeeper的设计目标

zookeeper致力于提供一个高性能、高可用，且具有严格的顺序访问控制能力（主要是写操作的严格顺序性）的分布式协调服务。高性能使得zookeeper能够应用于那些**对系统吞吐有明确要求的大型分布式系统**中，高可用使得**分布式的单点问题**得到了很好的解决，而严格的顺序访问控制使得客户端能够给予zookeeper实现一些**复杂的同步原语**。zookeeper四个设计目标如下：

## 简单的数据模型

zookeeper使得分布式程序能够通过一个共享的、树形结构的名字空间来进行相互协调。其数据模型类似于一个文件系统，而数据节点ZNode之间的层级关系，就像文件系统的目录结构一样。不过zookeeper将全量数据存储在内存中，以此来实现提高服务器吞吐、减少延迟的目的。

## 可以构建集群

一个zookeeper集群通常有一组机器组成，一般3~5台机器就可以组成一个可用的zookeeper集群。

组成zookeeper集群的每台机器都会在内存中维护当前的服务器状态，并且每台机器之间都互相保持通行。只要集群中存在超过一半的机器能够正常工作，那么整个集群就能够正常对外服务。

## 顺序访问

对于来自客户端的每个更新请求，zookeeper都会分配一个全局唯一的递增编号，这个编号反映了所有实务操作的先后顺序

## 高性能

由于zookeeper将全量数据存储在内存中，并直接服务于客户端的所有非实物请求，因此它尤其适用于以读操作为主的应用场景。

## zookeeper基本概念

### 集群角色

zookeeper没有沿用传统的Master/Slave概念，而是引入了Leader、Follower、Observer三种角色。zookeeper集群中的所有机器通过一个Leader选举过程来选定一台被称为“Leader”的机器，Leader服务器为客户端**提供读和写服务**。Follower和Observer都能够提供读服务，唯一的区别在于，Observer机器不参与Leader选举过程，也不参与写操作的“过半写成功”策略，因此Observer可以在不影响写性能的情况下提升集群的读性能。

### 会话（session）

Session是指客户端会话

在zookeeper中，一个客户端连接是指客户端和服务器之间的一个TCP长连接。客户端启动的时候，首先会与服务器建立一个TCP连接，从第一次连接建立开始，客户端会话的生命周期也开始了，**通过这个连接，客户端能够通过心跳检测与服务器保持有效会话，也能够向zookeeper服务器发送请求并接受响应，同时还能够通过该连接接受来自服务器的Watch事件通知**。

当由于服务器压力太大、网络故障或是客户端主动断开连接等各种原因导致客户端连接断开时，只要在sessionTimeout规定时间内能够重新连接上集群中任意一台服务器，那么之前创建的会话仍然有效。

## 数据节点（Znode）

在zookeeper中，ZNode可以分为**持久节点**和**临时节点**两类。所谓持久节点是指一旦这个ZNode被创建了，除非主动进行ZNode的一处操作，否则这个ZNode将一直保存在zookeeper上。临时节点的生命周期和客户端会话绑定，一旦客户端会话失效，那么这个客户端创建的所有临时节点都会被移除。

## Watcher

Watcher（事件监听器），是zookeeper中的一个很重要的特性。zookeeper允许用户在指定节点上注册一些Watcher，并且在一些特定事件触发的时候，zookeeper服务端会将事件通知到感兴趣的客户端上，该机制是zookeeper实现分布式协调服务的重要特性。