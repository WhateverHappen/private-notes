## 过半机制

为保证数据一致性，zookeeper在**leader选举**以及**集群数据更新**时实行过半机制。那么为什么要过半呢？

（以集群数据已有过半更新完毕为前提）zookeeper的leader在选举时，每个服务器会将选举请求中的ZXID（事务ID）与自身ZXID比较，**如果请求中的ZXID大于自身ZXID，那么该服务器就会投同意，当一个服务器提出的请求有过半数的同意，那么就认为选出了leader**。假设现有编号为1,2,3的三台服务器，其中服务器1数据不是最新状态，服务器2,3数据是最新状态。假设在leader选举的时候，不需要遵循过半机制，那么就有可能出现这种情况：

服务器1发出当leader的请求，首先他会投自己一票，这时不需要过半，那么此时就认定选出了leader，为服务器1，那么各服务器此时将会与服务器1同步数据，但是此时服务器1的数据并不是最新状态，这将导致数据的丢失。

在集群数据更新时，假设不需要过半机制，仅仅有一小部分服务器完成了数据的更新，如果此时leader宕机，需要重新选举leader时，由于拥有最新数据的服务器并不占多数，那么此时就有可能会选出一个数据并不是最新的服务器做leader，在各服务器同leader进行同步后，同样会导致数据丢失。

## 为什么最好配置奇数台

+ 容错：假设现有5台服务器，由于zookeeper实行过半机制，因此在选举时，需要3台服务器投票同意，此时容许有两台服务器挂掉；如果有4台服务器，同样3需要台服务器投同意票，只容许一台服务器挂掉。
+ 防脑裂：假设现有5台服务器，如果此时服务器之间通信出现问题，集群分成了2台服务器和3台服务器两部分，但是3台服务器的部分仍然能够对外提供服务。如果有4台服务器，通信出现问题，导致整个集群分成2台服务器和2台服务器两部分，由于需要过半即3台机器投票同意，那么将导致整个集群无法提供服务。