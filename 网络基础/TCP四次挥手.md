# 四次挥手

所谓四次挥手(Four-Way Wavehand)即终止TCP连接，就是指断开一个TCP连接时，需要客户端和服务端总共发送4个包以确认连接的断开。在socket编程中，这一过程由客户端或服务端任一方执行close来触发，整个流程如下图所示：

![20170309191225915](D:\Idea\IntelliJ IDEA 2017.1.1\workspace\private-notes\网络基础\20170309191225915.png)

由于TCP连接是全双工的，因此，每个方向都必须要单独进行关闭，这一原则是当一方完成数据发送任务后，发送一个FIN来终止这一方向的连接，**收到一个FIN只是意味着这一方向上没有数据流动了，即不会再收到数据了，但是在这个TCP连接上仍然能够发送数据，直到这一方向也发送了FIN。**首先进行关闭的一方将执行主动关闭，而另一方则执行被动关闭

1. 第一次挥手：Client发送一个FIN，用来关闭Client到Server的数据传送，Client进入FIN_WAIT_1状态
2. 第二次挥手：Server收到FIN后，发送一个ack给Client，确认序号为收到序号+1(与SYN相同，一个FIN占用一个序号)，Server进入CLOSE_WAIT状态
3. 第三次挥手：Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入LAST_ACK状态
4. 第四次挥手：Client收到FIN后，Client进入TIME_WAIT状态，接着发送一个ack给Server，确认序号为收到序号+1，若Server端没有收到ack，则可以重传。若Client等待2MSL(最大报文段生存时间)后仍没收到回复，则证明Server端已正常关闭，则Client端可以关闭连接，Server进入CLOSED状态，完成四次挥手。

## 总结

起初A和B处于**ESTABLISHED状态**——A发出连接释放报文段并处于**FIN-WAIT-1状态**——B发出确认报文段且进入**CLOSE-WAIT状态**——A收到确认后，进入**FIN-WAIT-2状态**，等待B的连接释放报文段——B没有要向A发出的数据，B发出连接释放报文段且进入**LAST-ACK状态**——A发出确认报文段且进入**TIME-WAIT状态**——B收到确认报文段后进入**CLOSED状态**——A经过等待计时器时间2MSL后，进入**CLOSED状态**。

# 问题

为什么连接的时候是三次握手，关闭的时候却是四次挥手？

因为服务端在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里发送给客户端。而关闭连接时，当收到对方的FIN报文时，仅仅表示对方不在发送数据了，但是还能接受数据，己方也未必全部数据都发送给对方了，所以己方可以立即close，也可以发送一些数据给对方后，在发送FIN报文给对方来表示同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送。